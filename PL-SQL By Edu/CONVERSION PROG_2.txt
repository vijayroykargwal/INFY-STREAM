CREATE OR REPLACE PROCEDURE SP_AP_SUPPLIER_SITES_INT_04(ERRBUF OUT VARCHAR2, RETCODE OUT VARCHAR2) 
IS
TYPE TYPE_SUPPLIER_SITES_INFO IS TABLE OF AP_SUPPLIERS_BASE_DUMMY_G04%ROWTYPE;
COL_SUPPLIER_SITES_INFO TYPE_SUPPLIER_SITES_INFO := TYPE_SUPPLIER_SITES_INFO();
V_COUNT_VENDOR NUMBER;
V_COUNT_COUNTRY NUMBER;
V_COUNT_ORG NUMBER;
V_VENDOR_ID NUMBER;
V_ORGANIZATION_NAME VARCHAR2(100);
BEGIN
SELECT VENDOR_INTERFACE_ID ,
VENDOR_NAME ,
VENDOR_SITE_CODE ,
ORG_ID ,
CREATED_BY ,
CREATION_DATE ,
LAST_UPDATE_DATE ,
LAST_UPDATE_LOGIN ,
LAST_UPDATED_BY ,
SHIP_TO_LOCATION_ID ,
BILL_TO_LOCATION_ID ,
INVOICE_CURRENCY_CODE ,
PAYMENT_CURRENCY_CODE ,
START_DATE_ACTIVE ,
ADDRESS_LINE1 ,
CITY ,
COUNTRY ,
RECORD_STATUS ,
VERIFY_FLAG ,
ERROR_MESSAGE  BULK COLLECT INTO COL_SUPPLIER_SITES_INFO FROM AP_SUPPLIERS_BASE_DUMMY_G04;

FOR V_INDEX IN COL_SUPPLIER_SITES_INFO.FIRST..COL_SUPPLIER_SITES_INFO.LAST
LOOP
---------VALIDATION OF VENDOR_NAME FOR VENDOR_ID------------------------
BEGIN
SELECT COUNT(VENDOR_NAME) INTO V_COUNT_VENDOR FROM PO_VENDORS WHERE 
UPPER(VENDOR_NAME) = UPPER(COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_NAME);
IF V_COUNT_VENDOR<=0 THEN 
UPDATE AP_SUPPLIERS_BASE_DUMMY_G04 SET VERIFY_FLAG='N',ERROR_MESSAGE='INVALID VENDOR NAME' WHERE
VENDOR_INTERFACE_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_INTERFACE_ID;
ELSE
SELECT VENDOR_ID INTO V_VENDOR_ID FROM PO_VENDORS WHERE 
UPPER(VENDOR_NAME) = UPPER(COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_NAME);
COMMIT;
CONTINUE;
END IF;
END;
-----------------------VALIDATION OF VENDOR_SITE_CODE------------------
BEGIN
IF COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_SITE_CODE IS NULL THEN
UPDATE AP_SUPPLIERS_BASE_DUMMY_G04 SET VERIFY_FLAG='N',ERROR_MESSAGE='Vendor site code cannot be null' WHERE
VENDOR_INTERFACE_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_INTERFACE_ID;
COMMIT;
CONTINUE;
END IF;
END;
-------------------VALIDATION OF COUNTRY-------------------------
BEGIN
SELECT COUNT(TERRITORY_CODE) INTO V_COUNT_COUNTRY FROM FND_TERRITORIES WHERE 
TERRITORY_CODE = COL_SUPPLIER_SITES_INFO(V_INDEX).COUNTRY;
IF V_COUNT_COUNTRY <=0 THEN
UPDATE AP_SUPPLIERS_BASE_DUMMY_G04 SET VERIFY_FLAG='N',ERROR_MESSAGE='Invalid country' WHERE
VENDOR_INTERFACE_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_INTERFACE_ID;
COMMIT;
CONTINUE;
END IF;
END;

-------------------VALIDATION OF ORG_ID--------------------------
BEGIN
IF COL_SUPPLIER_SITES_INFO(V_INDEX).ORG_ID IS NULL THEN
UPDATE AP_SUPPLIERS_BASE_DUMMY_G04 SET VERIFY_FLAG='N',ERROR_MESSAGE='Org_id cannot be null' WHERE
VENDOR_INTERFACE_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_INTERFACE_ID;
ELSE
SELECT COUNT(ORGANIZATION_NAME) INTO V_COUNT_ORG FROM ORG_ORGANIZATION_DEFINITIONS WHERE
ORGANIZATION_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).ORG_ID;
IF V_COUNT_ORG <=0 THEN
UPDATE AP_SUPPLIERS_BASE_DUMMY_G04 SET VERIFY_FLAG='N',ERROR_MESSAGE='Invalid organization' WHERE
VENDOR_INTERFACE_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_INTERFACE_ID;
ELSE
SELECT ORGANIZATION_NAME INTO V_ORGANIZATION_NAME FROM ORG_ORGANIZATION_DEFINITIONS WHERE 
ORGANIZATION_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).ORG_ID;
IF V_ORGANIZATION_NAME != 'Vision Operations' THEN
UPDATE AP_SUPPLIERS_BASE_DUMMY_G04 SET VERIFY_FLAG='N',ERROR_MESSAGE='Invalid organization' WHERE
VENDOR_INTERFACE_ID = COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_INTERFACE_ID;
END IF;
END IF;
COMMIT;
CONTINUE;
END IF;
END;
-----------------INSERT INTO AP_SUPPLIER_SITES_INT_DMY_G04 TABLE---------------------
---DROP SEQUENCE SEQ_VENDOR_SITE_INT_ID_G04--------------------------
---CREATE SEQUENCE SEQ_VENDOR_SITE_INT_ID_G04 START WITH 767103--------------------
DECLARE
V_CREATED_BY VARCHAR2(100) := FND_PROFILE.VALUE('USER_ID');
V_LAST_UPDATE_LOGIN VARCHAR2(100) := FND_PROFILE.VALUE('LOGIN_ID');
V_LAST_UPDATED_BY VARCHAR2(100):= FND_PROFILE.VALUE('USER_ID');
BEGIN
IF COL_SUPPLIER_SITES_INFO(V_INDEX).ERROR_MESSAGE IS NULL THEN
INSERT INTO AP_SUPPLIER_SITES_INT_DMY_G04 VALUES(SEQ_VENDOR_SITE_INT_ID_G04.NEXTVAL,COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_NAME,
COL_SUPPLIER_SITES_INFO(V_INDEX).VENDOR_SITE_CODE,COL_SUPPLIER_SITES_INFO(V_INDEX).ORG_ID,V_CREATED_BY,
SYSDATE,SYSDATE,V_LAST_UPDATE_LOGIN,V_LAST_UPDATED_BY,
COL_SUPPLIER_SITES_INFO(V_INDEX).SHIP_TO_LOCATION_ID,
COL_SUPPLIER_SITES_INFO(V_INDEX).BILL_TO_LOCATION_ID,
COL_SUPPLIER_SITES_INFO(V_INDEX).INVOICE_CURRENCY_CODE,
COL_SUPPLIER_SITES_INFO(V_INDEX).PAYMENT_CURRENCY_CODE,
COL_SUPPLIER_SITES_INFO(V_INDEX).START_DATE_ACTIVE,
COL_SUPPLIER_SITES_INFO(V_INDEX).ADDRESS_LINE1,
COL_SUPPLIER_SITES_INFO(V_INDEX).CITY,
COL_SUPPLIER_SITES_INFO(V_INDEX).COUNTRY,
COL_SUPPLIER_SITES_INFO(V_INDEX).RECORD_STATUS,NULL,NULL);
COMMIT;
END IF;
END;
END LOOP;
END;
------------------------------PROCEDURE END-------------------------------------